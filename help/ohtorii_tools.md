# ohtorii_tools.dll について

# はじめに

ohtorii_tools.dllはUnityマクロの中心となるDLLです。

このDLLを保守する目的で全体を俯瞰するドキュメントを用意しました、詳細はソースコードを参照してください。


# ファイル構成

## DLLインターフェース

|ファイル|説明|備考|
|--|--|--|
|Source.def|DLLからエクスポートする関数定義||
|dll_export.cpp|DLLインターフェースの実装||
|interface_sugar.*|秀丸マクロ側の記述を簡易にする目的|「苦いインターフェースを糖衣で包み利用しやすくする」という意味です。|


## メイン処理

|ファイル|説明|備考|
|--|--|--|
|unity.*|処理の本体||
|sources.*|ソースの処理||
|candidates.*|候補の処理||
|kinds.*|カインドの処理||
|inheritance.*|カインドの継承を処理する||
|refine_search.*|検索処理||

## 非同期処理

|ファイル|説明|備考|
|--|--|--|
|recurring_task.*|定期処理||
|callback.*|コールバック処理||
|async_files.*|テキストファイルを非同期で読み込み候補を追加します||
|auto_preview.*|テキストファイルのauto-previewを行います。||


## 状態

|ファイル|説明|備考|
|--|--|--|
|context_status.*|コンテキスト毎の状態||
|static_statuc.*|プロセスをまたぐ静的な状態||
|user_data.*|ユーザーデータ||

## その他

|ファイル|説明|備考|
|--|--|--|
|hidemaru_functions.*|秀丸エディタへの関数ポインタ||
|file.*|ファイル処理||
|log.*|ログ出力||


# シリアライズ(cereal)について

秀丸エディタはマルチプロセスで動作しています、そのため、プロセスをまたいでデータをやりとりする目的でシリアライズのライブラリ(cereal)を利用しています。
このライブラリは生ポインタを扱えないためstd::shared_ptrを利用しています。

## ライブラリのフォルダ位置
external\cereal

# 本ライブラリの呼び出し方

あらゆる機能はUnity::Instance()を介して呼び出します。

以下のパターンです。

	Unity::Instance().lock()->Query???()

具体例は dll_export.cpp を参照してください。


# 固有名詞について

ohtorii_tools.dllで利用している固有名詞について説明します。

## コンテキスト(context)

候補の絞り込み検索と選択候補に対するアクション実行に必要な情報です。

コンテキストに含まれる情報の例。

- 候補
- 絞り込み検索
- 非同期ファイル
- コンテキスト毎の状態
- ユーザーデータ

秀丸エディタ側でTABキーを押下するとコンテキストが切り替わり、ESCキーを押下すると直前のコンテキストへ戻ります。


